!function(){L.Control.LinearMeasurement=L.Control.extend({options:{position:"topleft",unitSystem:"imperial",color:"#4D90FE",contrastingColor:"#fff"},onAdd:function(a){function f(a){return g(a)>=165?"000":"fff"}function g(a){var b="string"==typeof a?h(a):a;return.2126*b[0]+.7152*b[1]+.0722*b[2]}function h(a){if(3===a.length)a=a.charAt(0)+a.charAt(0)+a.charAt(1)+a.charAt(1)+a.charAt(2)+a.charAt(2);else if(6!==a.length)throw"Invalid hex color: "+a;for(var b=[],c=0;c<=2;c++)b[c]=parseInt(a.substr(2*c,2),16);return b}var b=L.DomUtil.create("div","leaflet-control leaflet-bar"),c=L.DomUtil.create("a","icon-ruler",b),d=a.getContainer(),e=this;c.href="#",c.title="Toggle measurement tool",L.DomEvent.on(c,"click",L.DomEvent.stop).on(c,"click",function(){L.DomUtil.hasClass(c,"icon-active")?(e.resetRuler(!!e.mainLayer),L.DomUtil.removeClass(c,"icon-active"),L.DomUtil.removeClass(d,"ruler-map"),e._map.fire("measure:stop")):(e.initRuler(),L.DomUtil.addClass(c,"icon-active"),L.DomUtil.addClass(d,"ruler-map"),e._map.fire("measure:start"))}),this.options.color&&this.options.color.indexOf("#")===-1?this.options.color="#"+this.options.color:this.options.color||(this.options.color="#4D90FE");var i=this.options.color.replace("#","");return this.options.contrastingColor="#"+f(i),b},onRemove:function(a){this.resetRuler(!!this.mainLayer)},initRuler:function(){var a=this._map;this.mainLayer=L.featureGroup(),this.mainLayer.addTo(this._map),a.touchZoom.disable(),a.doubleClickZoom.disable(),a.boxZoom.disable(),a.keyboard.disable(),a.tap&&a.tap.disable(),this.dblClickEventFn=function(a){L.DomEvent.stop(a)},a.on("click",this.getMouseClickHandler,this),a.on("mousemove",this.getMouseMoveHandler,this),a.on("dblclick",this.dblClickEventFn,a),this.resetRuler()},initLayer:function(){this.layer=L.featureGroup(),this.layer.addTo(this.mainLayer),this.layer.on("selected",this.layerSelected),this.layer.on("click",this.getMouseClickHandler,this),this.layer.on("dblclick",this.getDblClickHandler,this)},resetRuler:function(a){var b=this._map;a&&(b.off("click",this.clickEventFn,this),b.off("mousemove",this.moveEventFn,this),b.off("dblclick",this.dblClickEventFn,b),this.mainLayer&&this._map.removeLayer(this.mainLayer),this.mainLayer=null,this._map.touchZoom.enable(),this._map.boxZoom.enable(),this._map.keyboard.enable(),this._map.tap&&this._map.tap.enable()),this.layer=null,this.prevLatlng=null,this.poly=null,this.multi=null,this.latlngs=null,this.latlngsList=[],this.sum=0,this.distance=0,this.separation=1,this.last=0,this.fixedLast=0,this.totalIcon=null,this.total=null,this.lastCircle=null,this.UNIT_CONV=1e3,this.SUB_UNIT_CONV=1e3,this.UNIT="km",this.SUB_UNIT="m","imperial"===this.options.unitSystem&&(this.UNIT_CONV=1609.344,this.SUB_UNIT_CONV=5280,this.UNIT="mi",this.SUB_UNIT="ft"),this.measure={scalar:0,unit:this.SUB_UNIT}},cleanUpMarkers:function(a){var b=this.layer;b&&b.eachLayer(function(c){c.options&&"tmp"===c.options.type&&(a?c.options.type="fixed":b.removeLayer(c))})},cleanUpFixed:function(){var a=this.layer;a&&a.eachLayer(function(b){b.options&&"fixed"===b.options.type&&a.removeLayer(b)})},convertDots:function(){var a=this,b=this.layer;b&&b.eachLayer(function(b){if(b.options&&"dot"===b.options.type){var c=b.options.marker,d=c?c.options.icon.options:null,e=d?d.html:"";if(e&&e.indexOf(a.measure.unit)===-1){var f=b.options.label,g=f.split(" "),h=parseFloat(g[0]),i=g[1],j="";b.options.label.indexOf(a.measure.unit)!==-1?j=b.options.label:i===a.UNIT?j=(h*a.SUB_UNIT_CONV).toFixed(2)+" "+a.SUB_UNIT:i===a.SUB_UNIT&&(j=(h/a.SUB_UNIT_CONV).toFixed(2)+" "+a.UNIT);var k=L.divIcon({className:"total-popup-label",html:j});c.setIcon(k)}}})},displayMarkers:function(a,b,c){var d,e,f,g,h,i=a[a.length-1],j=a[0],k=j.distanceTo(i)/this.UNIT_CONV,l=k,m=this._map.latLngToContainerPoint(i),n=this._map.latLngToContainerPoint(j),o=1;this.measure.unit===this.SUB_UNIT&&(o=this.SUB_UNIT_CONV,l*=o);for(var p=c*o+l,q=c*o,r=Math.floor(q);r<p;r++)g=(p-r)/l,r%this.separation||r<q||(d=m.x-g*(m.x-n.x),e=m.y-g*(m.y-n.y),h=L.point(d,e),i=this._map.containerPointToLatLng(h),f=r+" "+this.measure.unit,this.renderCircle(i,0,this.layer,b?"fixed":"tmp",f),this.last=p);return k},renderCircle:function(a,b,c,d,e){var f=this.options.color,g=this.options.color;d=d||"circle",linesHTML=[];var h={color:g,fillOpacity:1,opacity:1,fill:!0,type:d},i=this._map.latLngToContainerPoint(a);if(p_latLng=this._map.containerPointToLatLng(i),e){var j=L.divIcon({className:"total-popup-label",html:'<span style="color: '+f+';">'+e+"</span>"});h.icon=j,h.marker=L.marker(p_latLng,{icon:j,type:d}).addTo(c),h.label=e}var k=L.circleMarker(a,h);return k.setRadius(3),k.addTo(c),k},renderPolyline:function(a,b,c){var d=L.polyline(a,{color:this.options.color,weight:2,opacity:1,dashArray:b});return d.addTo(c),d},renderMultiPolyline:function(a,b,c){var d;return d=L.version.startsWith("0")?L.multiPolyline(a,{color:this.options.color,weight:2,opacity:1,dashArray:b}):L.polyline(a,{color:this.options.color,weight:2,opacity:1,dashArray:b}),d.addTo(c),d},formatDistance:function(a,b){var c=L.Util.formatNum(a<1?a*parseFloat(this.SUB_UNIT_CONV):a,b),d=a<1?this.SUB_UNIT:this.UNIT;return{scalar:c,unit:d}},hasClass:function(a,b){var c=L.DomUtil.hasClass;for(var d in b)if(c(a,b[d]))return!0;return!1},getMouseClickHandler:function(a){var b=this,c=a.originalEvent.target;if(!this.hasClass(c,["leaflet-popup","total-popup-content"])){b.layer||b.initLayer(),b.cleanUpMarkers(!0),b.fixedLast=b.last,b.prevLatlng=a.latlng,b.sum=0,b.poly&&(b.latlngsList.push(b.latlngs),b.multi?b.multi.setLatLngs(b.latlngsList):b.multi=b.renderMultiPolyline(b.latlngsList,"5 5",b.layer,"dot"));var d,e;for(var f in b.latlngsList)d=b.latlngsList[f],b.sum+=d[0].distanceTo(d[1])/b.UNIT_CONV;e=b.measure.unit===this.SUB_UNIT?b.sum*b.SUB_UNIT_CONV:b.sum;var g=e.toFixed(2);b.renderCircle(a.latlng,0,b.layer,"dot",parseInt(g)?g+" "+b.measure.unit:"")}},getMouseMoveHandler:function(a){if(this.prevLatlng){this.latlngs=[this.prevLatlng,a.latlng],this.poly?this.poly.setLatLngs(this.latlngs):this.poly=this.renderPolyline(this.latlngs,"5 5",this.layer),this.distance=parseFloat(this.prevLatlng.distanceTo(a.latlng))/this.UNIT_CONV,this.measure=this.formatDistance(this.distance+this.sum,2);var b=this.measure.scalar+" "+this.measure.unit,c='<span class="total-popup-content" style="background-color:'+this.options.color+"; color: "+this.options.contrastingColor+'">'+b+"</span>";this.total?(this.totalIcon=L.divIcon({className:"total-popup",html:c}),this.total.setLatLng(a.latlng),this.total.setIcon(this.totalIcon)):(this.totalIcon=L.divIcon({className:"total-popup",html:c}),this.total=L.marker(a.latlng,{icon:this.totalIcon,clickable:!0}).addTo(this.layer));var d=this.measure.scalar,e=this.separation,f=parseInt(d).toString().length,g=Math.pow(10,f),h=d>g/2?g/10:g/20,i=0;if(this.separation=h,e!==this.separation&&this.fixedLast){this.cleanUpMarkers(),this.cleanUpFixed();var j=this.multi.getLatLngs();for(var k in j)i+=this.displayMarkers.apply(this,[j[k],!0,i]);this.displayMarkers.apply(this,[this.poly.getLatLngs(),!1,this.sum]),this.convertDots()}else this.cleanUpMarkers(),this.displayMarkers.apply(this,[this.poly.getLatLngs(),!1,this.sum])}},getDblClickHandler:function(a){var b=this;if(this.total){this.cleanUpLastNodes(),this.layer.off("click"),this.layer.off("dblclick"),L.DomEvent.stop(a);var c=this.layer,d=this.measure.scalar+" "+this.measure.unit+" ",g=(this.measure.unit===this.SUB_UNIT?this.measure.scalar/this.UNIT_CONV:this.measure.scalar,this.total.getLatLng(),this.total),h=['<div class="total-popup-content" style="background-color:'+this.options.color+"; color: "+this.options.contrastingColor+'">'+d,'  <svg class="close" viewbox="0 0 45 35">','   <path style="stroke: '+this.options.contrastingColor+'" class="close" d="M 10,10 L 30,30 M 30,10 L 10,30" />',"  </svg>","</div>"].join("");this.totalIcon=L.divIcon({className:"total-popup",html:h}),this.total.setIcon(this.totalIcon);var i={total:this.measure,total_label:g,unit:this.UNIT_CONV,sub_unit:this.SUB_UNIT_CONV},j=function(a){L.DomUtil.hasClass(a.originalEvent.target,"close")?b.mainLayer.removeLayer(c):c.fireEvent("selected",i)};c.on("click",j),c.fireEvent("selected",i),this.resetRuler(!1)}},cleanUpLastNodes:function(){var a=[];this.layer.eachLayer(function(b,c){"dot"===b.options.type&&a.push(b)}),this.purgeLayers(a.splice(-4))},purgeLayers:function(a){for(var b in a)a[b]&&this.layer.removeLayer(a[b])},layerSelected:function(a){}})}();
